</div>
</div>
</div>
</div>
<!-- large modal -->
<div class="modal fade no-print" id="largeModal" tabindex="-1" role="dialog" aria-labelledby="basicModal" aria-hidden="true">
<div class="modal-dialog modal-lg" id="modal3" >
<div class="modal-content " id="modal">
<div id="modal2">
  <button type="button" class="close text-white mr-5 mt-2" data-dismiss="modal" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
  <div class="panel-group " id="accordion">
    <div class="panel bg-info text-light">
      <div class="panel-heading ">
        <h4 class="panel-title">
          <a>DETALHES DA SOLICITAÇÃO</a>
        </h4>
      </div>
    </div><!-- /input-group image-preview [TO HERE]-->
  </div>
</div>

<div class="modal-body" id="bodyModal">
  <div class="card fixed " style="height: 700px; text-align: right;" id="campos">
    <div class="panel-group">
      <div class="panel bg-dark text-light">
        <div class="panel-heading">
          <h4 class="panel-title text-center">
            <a id="nome-solicitacao"> Se Mate</a>
          </h4>
        </div>
      </div><!-- /input-group image-preview [TO HERE]-->
    </div>

      <div class="card-body px-lg-5 pt-0 pt-30 overflow-auto"  id="cardSolici">
        <form class="text-left " style="color: #757575;" action="index.html" method="post" id="form-solicitacao" >
          <div class="col">
            <div class="md-form">
              <div class="input-group mb-3">
                <label for="">Solicitanate :</label>
                <label id = "solicitante" for=""></label>
                <br>
                <label for="">Data e hora da solicitação:</label>
                <label id = "data" for=""></label>
              </div>
            </div>

            <div class="body-solicitacao" id = "body-solicitacao">
              <div class="itens"></div>
            </div>

          </div>
        </form>
      </div>

      <div class="form-group float-right mr-5" id="btns">
        <button type="button" class="btn btn-success btn-sm d-none" id="btn-enviar">
        <span class="glyphicon glyphicon-send"></span> Enviar</button>
        <button type="submit" class="btn btn-success btn-sm d-none" id="btn-guardar">
        <span class="glyphicon glyphicon-floppy-disk"></span>Guardar Alterações</button>
        <button type="submit" class="btn btn-success btn-sm  d-none" id="btn-analisar">
        <span class="glyphicon glyphicon-pencil"></span>Analisar</button>
        <button type="submit" class="btn btn-success btn-sm  d-none" id="btn-aceitar">
        <span class="glyphicon glyphicon-floppy-disk"></span>Aceitar</button>
        <button type="submit" class="btn btn-danger btn-sm  d-none" id="btn-recusar">
        <span class="glyphicon glyphicon-floppy-disk"></span>Recusar</button>
        <button type="submit" class="btn btn-success btn-sm" id="btn-imprimir">
        <span class="glyphicon glyphicon-print" id="imprimir"></span> Imprimir</button>
      </div>

</div>
<div class="">
  <div id="comentarios" class="card-body col-md-6 mt-5 float-right overflow-auto " style="background-color:#DCDCDC; height: 185px;">
    <p>k</p>
  </div>
  <div class="col-md-6 mt-0">
    <div class="widget-area no-padding blank">
      <div class="status-upload">
        <form id="form-comentario">
          <textarea id="comentario" placeholder="Escreva o seu comentário" ></textarea>
          <button type="submit" class="btn btn-success green"><i class="fa fa-share"></i> Comentar</button>
        </form>
      </div><!-- Status Upload  -->
    </div><!-- Widget Area -->
  </div>
</div>


</div>


<div class="modal-footer no-print" >
  <button type="button" class="btn btn-danger" data-dismiss="modal">Sair</button>
  <button type="button" class="btn btn-primary">Salvar</button>
</div>
</div>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>


<style type="text/css">
.custom-select{
    background-color:#2473A4;
    background-size:10% 50%;
    color:#FAFAFA;
    border-radius: 0px 0px 0px;
    height:30px;
    width:100%;
    border:0px;
    font-size: 14px;
}


@media (max-width: 575.98px) {
.form-row {
display: block;
}
.body-solicitacao{
display: block;
}
}

}

body{ background: #fafafa;}
.widget-area.blank {
background: none repeat scroll 0 0 rgba(0, 0, 0, 0);
-webkit-box-shadow: none;
-moz-box-shadow: none;
-ms-box-shadow: none;
-o-box-shadow: none;
box-shadow: none;
}
body .no-padding {
padding: 0;
}
.widget-area {
background-color: #fff;
-webkit-border-radius: 4px;
-moz-border-radius: 4px;
-ms-border-radius: 4px;
-o-border-radius: 4px;
border-radius: 4px;
-webkit-box-shadow: 0 0 16px rgba(0, 0, 0, 0.05);
-moz-box-shadow: 0 0 16px rgba(0, 0, 0, 0.05);
-ms-box-shadow: 0 0 16px rgba(0, 0, 0, 0.05);
-o-box-shadow: 0 0 16px rgba(0, 0, 0, 0.05);
box-shadow: 0 0 16px rgba(0, 0, 0, 0.05);
float: left;
margin-top: 30px;
padding: 25px 30px;
position: relative;
width: 100%;
}

#comentarios{
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  -ms-border-radius: 4px;
  -o-border-radius: 4px;
  border-radius: 4px;
  float: left;
  width: 100%;
}
.status-upload {
background: none repeat scroll 0 0 #f5f5f5;
-webkit-border-radius: 4px;
-moz-border-radius: 4px;
-ms-border-radius: 4px;
-o-border-radius: 4px;
border-radius: 4px;
float: left;
width: 100%;
}
.status-upload form {
float: left;
width: 100%;
}
.status-upload form textarea {
background: none repeat scroll 0 0 #fff;
border: medium none;
-webkit-border-radius: 4px 4px 0 0;
-moz-border-radius: 4px 4px 0 0;
-ms-border-radius: 4px 4px 0 0;
-o-border-radius: 4px 4px 0 0;
border-radius: 4px 4px 0 0;
color: #777777;
float: left;
font-family: Lato;
font-size: 14px;
height: 142px;
letter-spacing: 0.3px;
padding: 20px;
width: 100%;
resize:vertical;
outline:none;
border: 1px solid #F2F2F2;
}

.status-upload ul {
float: left;
list-style: none outside none;
margin: 0;
padding: 0 0 0 15px;
width: auto;
}
.status-upload ul > li {
float: left;
}
.status-upload ul > li > a {
-webkit-border-radius: 4px;
-moz-border-radius: 4px;
-ms-border-radius: 4px;
-o-border-radius: 4px;
border-radius: 4px;
color: #777777;
float: left;
font-size: 14px;
height: 30px;
line-height: 30px;
margin: 10px 0 10px 10px;
text-align: center;
-webkit-transition: all 0.4s ease 0s;
-moz-transition: all 0.4s ease 0s;
-ms-transition: all 0.4s ease 0s;
-o-transition: all 0.4s ease 0s;
transition: all 0.4s ease 0s;
width: 30px;
cursor: pointer;
}
.status-upload ul > li > a:hover {
background: none repeat scroll 0 0 #606060;
color: #fff;
}
.status-upload form button {
border: medium none;
-webkit-border-radius: 4px;
-moz-border-radius: 4px;
-ms-border-radius: 4px;
-o-border-radius: 4px;
border-radius: 4px;
color: #fff;
float: right;
font-family: Lato;
font-size: 14px;
letter-spacing: 0.3px;
margin-right: 9px;
margin-top: 9px;
padding: 6px 15px;
}
.dropdown > a > span.green:before {
border-left-color: #2dcb73;
}
.status-upload form button > i {
margin-right: 7px;
}
</style>

<script type="text/javascript">
  $('#demo01').click((event) =>{
  event.preventDefault();
  this.blur(); // Manually remove focus from clicked link.
  $.get(this.href, function(html) {
    $(html).appendTo('body').animatedModal();
  });
});

  $('#imprimir').click(()=>{
window.print('new', '_blank');
});

  var gsolicitacao;
  var server = '<%=server_ui;%>';
  $('#btn-analisar').click(()=>{
    gsolicitacao.status = 'EM_ESPERA';
    alterarStatus(gsolicitacao);
  });
  $('#btn-aceitar').click(()=>{
    gsolicitacao.status = 'APROVADA';
    alterarStatus(gsolicitacao);
  });
  $('#btn-recusar').click(()=>{
    gsolicitacao.status = 'REPROVADA';
    alterarStatus(gsolicitacao);
  });
  $('#btn-enviar').click(()=>{
    gsolicitacao.status = 'ENVIADA';
    alterarStatus(gsolicitacao);
  });
  $('#btn-guardar').click(()=>{
    gsolicitacao.itens.forEach((item)=>{
      item.campos.forEach((campo)=>{
        campo.valor = $("#"+campo.id).val();
      });
    });
    solicitacao_json = JSON.stringify(gsolicitacao);
    $.post(server+'solicitacoes/altualizar',{
      solicitacao:solicitacao_json
    },(data)=>{
      alert(data);
    });
  });
  $('#form-comentario').submit((event)=>{
    event.preventDefault();
    comentar(gsolicitacao);
  });
  function pars(solicitacao){
    hiddenAndShowButtons(solicitacao?solicitacao:gsolicitacao);
    gsolicitacao = solicitacao;
    $('#solicitante').html(gsolicitacao.solicitanteDelegante.nome);
    $('#data').html(gsolicitacao.dataEnvio);
    $('.body-solicitacao').html('');
    $('#nome-solicitacao').html(gsolicitacao.tipoSolicitacaoDelegacao.nome);
    gsolicitacao.itens.forEach((item)=>{
      html =  '<hr>';
      html += "<h3>"+item.tipoItem.nome+"</h3>";
      html += '<div class="form-row tipo-itens" id="'+item.id+'">'
        size = item.campos.length>3?'col-4':'col';
        item.campos.forEach((campo)=>{
          html += montarCampo(campo,size,gsolicitacao.status);
        });
      html += '</div>';
    });
    $('.body-solicitacao').append(html);

    getComentario(gsolicitacao);

  }

  function moverInputFile(item){
    var files = [];
    for(i = 0; i < item.campos.tipoCampo.length; i++){
      if(item.campos.tipoCampo[i].tipo=='file'){
        files.push(item.campos.tipoCampo[i]);
        item.campos.tipoCampo.splice(i, 1);
      }
    };
    return item.tipoCampos.concat(files);
  }

  function montarCampo(campo,size,status){
    size = campo.tipo=='textarea'?'col-12':size;
    htmlCampo = '<div class="'+size+' orm-group " >';
      htmlCampo+='<label>'+campo.tipoCampo.nome+'</label>';
      tipo = campo.tipo=='file'?'-file':'';
      htmlCampo +='<input name = "campo" id="'+campo.id+'" type="'+campo.tipoCampo.tipo+'" class="form-control'+tipo+' tipo-campos" value="'+campo.valor+'"';
      if(status == "SALVA"){
        htmlCampo += '>';
      }else{
        htmlCampo +=' disabled>'
      }

    htmlCampo += '</div>';
    return htmlCampo;
  }

  function comentar(solicitacao){
    comentario = $('#comentario').val();
    if(!comentario==''){
      comentario = {
        comentario:$('#comentario').val(),
        solicitacaoDelegacao:{id:solicitacao.id},
        funcionario:{id:<%=funcionario.id;%>},
      };
      comentario = JSON.stringify(comentario);
      $.post(server+'solicitacoes/comentar',{comentario:comentario});
      $('#comentario').val('');
    }else{
      alert("Escreva um comentário");
    }
  }

  function getComentario(solicitacao){
    $.get(server+'solicitacoes/comentarios?solicitacao='+solicitacao.id, (data)=>{
      html = '';
      data.forEach((comentario)=>{
        html += '<p>';
        html += comentario.funcionario.nome+': ';
        html += comentario.comentario;
        html += '<p>';
      });
      $('#comentarios').html(html);
    });
  }

  function hiddenAndShowButtons(solicitacao){
      $('#btns  button').addClass('d-none');
      $('#btn-imprimir').removeClass('d-none');
      funcionario_id = <%=funcionario.id;%>;
      if(solicitacao.solicitanteDelegante.id != funcionario_id){
        if (solicitacao.status == 'ENVIADA') {
         $('#btn-analisar').removeClass('d-none');
        }else if(solicitacao.status == 'EM_ESPERA'){
          $('#btn-aceitar').removeClass('d-none');
          $('#btn-recusar').removeClass('d-none');
        }
      }else if(solicitacao.status == 'SALVA'){
        $('#btn-guardar').removeClass('d-none');
        $('#btn-enviar').removeClass('d-none');
      }
  }

  function alterarStatus(solicitacao){
    solicitacao_json = JSON.stringify(solicitacao);
    $.post(server+'solicitacoes/alterar-status',{
      solicitacao:solicitacao_json
    },(data)=>{
      alert(data);
      moverSolicitacao(solicitacao);
    });
  }

  function moverSolicitacao(solicitacao){
    div_solicitacao = $('#'+solicitacao.id);
    $('#'+solicitacao.id).remove();
    hiddenAndShowButtons(solicitacao);
    if(solicitacao.status == 'EM_ESPERA'){
      $('#solicitacoes-analise h1').remove();
      $('#solicitacoes-analise').append(div_solicitacao);
    }else if(solicitacao.status == 'APROVADA'){
      $('#solicitacoes-confirmadas h1').remove();
      $('#solicitacoes-confirmadas').append(div_solicitacao);
    }
    else if(solicitacao.status == 'REPROVADA'){
      $('#solicitacoes-recusadas h1').remove();
      $('#solicitacoes-recusadas').append(div_solicitacao);
    }
    else if(solicitacao.status == 'ENVIADA'){
      $('#solicitacoes-enviadas h1').remove();
      $('#solicitacoes-enviadas').append(div_solicitacao);
    }

  }

  let socket = io();
  socket.on('comentar',(data)=>{
    comentario = JSON.parse(data);
    getComentario(comentario.solicitacaoDelegacao);
  });
  socket.on('notificar',(data)=>{
    solicitacao = JSON.parse(data);
    if(gsolicitacao.solicitanteDelegante.id == <%=funcionario.id;%>){
      alert('Notificação');
      moverSolicitacao(solicitacao);
    }
  });

</script>
